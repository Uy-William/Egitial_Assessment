import e,{useRef as t,useContext as r,useEffect as s}from"react";import o from"events";const i=e.createContext();i.displayName="ClientContext";var n=function(e){return"undefined"!=typeof File&&e instanceof File||"undefined"!=typeof Blob&&e instanceof Blob||e instanceof class{constructor({uri:e,name:t,type:r}){this.uri=e,this.name=t,this.type=r}}};const a=e=>n(e)||null!==e&&"object"==typeof e&&"function"==typeof e.pipe||null!==e&&"object"==typeof e&&"function"==typeof e.stream;class c{constructor(e){0===e.length&&e.push(((e,t)=>t()));for(const t of e){if("function"!=typeof t)throw Error("GraphQLClient Middleware: middleware has to be of type `function`");this.run=(e=>(r,s)=>{e(r,(()=>{t.call(this,r,s.bind.call(s,null,r))}))})(this.run)}}run(e,t){t.apply(this,e)}}class u{constructor(e={}){this.fullWsTransport=e.fullWsTransport,this.subscriptionClient=e.subscriptionClient,"function"==typeof this.subscriptionClient&&(this.subscriptionClient=this.subscriptionClient()),this.verifyConfig(e),this.cache=e.cache,this.headers=e.headers||{},this.ssrMode=e.ssrMode,this.ssrPromises=[],this.url=e.url,this.fetch=e.fetch||"undefined"!=typeof fetch&&fetch&&fetch.bind(),this.fetchOptions=e.fetchOptions||{},this.FormData=e.FormData||("undefined"!=typeof FormData?FormData:void 0),this.logErrors=void 0===e.logErrors||e.logErrors,this.onError=e.onError,this.useGETForQueries=!0===e.useGETForQueries,this.middleware=new c(e.middleware||[]),this.mutationsEmitter=new o}verifyConfig(e){if(!e.url){if(!this.fullWsTransport)throw Error("GraphQLClient: config.url is required");if(!this.subscriptionClient)throw Error("GraphQLClient: subscriptionClient is required")}if(e.fetch&&"function"!=typeof e.fetch)throw Error("GraphQLClient: config.fetch must be a function");if(("undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement||e.ssrMode)&&!e.fetch&&"function"!=typeof fetch)throw Error("GraphQLClient: fetch must be polyfilled or passed in new GraphQLClient({ fetch })");if(e.ssrMode&&!e.cache)throw Error("GraphQLClient: config.cache is required when in ssrMode")}setHeader(e,t){return this.headers[e]=t,this}setHeaders(e){return this.headers=e,this}removeHeader(e){return delete this.headers[e],this}logErrorResult({result:e,operation:t}){console.error("GraphQL Hooks Error"),console.groupCollapsed("---\x3e Full Error Details"),console.groupCollapsed("Operation:"),console.log(t),console.groupEnd();const r=e.error;r&&(r.fetchError&&(console.groupCollapsed("FETCH ERROR:"),console.log(r.fetchError),console.groupEnd()),r.httpError&&(console.groupCollapsed("HTTP ERROR:"),console.log(r.httpError),console.groupEnd()),r.graphQLErrors&&r.graphQLErrors.length>0&&(console.groupCollapsed("GRAPHQL ERROR:"),r.graphQLErrors.forEach((e=>console.log(e))),console.groupEnd())),console.groupEnd()}generateResult({fetchError:e,httpError:t,graphQLErrors:r,data:s}){return!!(r&&r.length>0||e||t)?{data:s,error:{fetchError:e,httpError:t,graphQLErrors:r}}:{data:s}}getCacheKey(e,t={}){return{operation:e,fetchOptions:{...this.fetchOptions,...t.fetchOptionsOverrides}}}getCache(e){const t=this.cache?this.cache.get(e):null;if(t)return t}saveCache(e,t){this.cache&&this.cache.set(e,t)}getFetchOptions(e,t={}){const r={method:"POST",headers:{...this.headers},...this.fetchOptions,...t};if("GET"===r.method)return r;const{clone:s,files:o}=function(e,t="",r=n){const s=new Map,o=new Map;return{clone:function e(t,i,n){let a=t;if(r(t)){a=null;const e=s.get(t);e?e.push(i):s.set(t,[i])}else{const r=Array.isArray(t)||"undefined"!=typeof FileList&&t instanceof FileList,s=t&&t.constructor===Object;if(r||s){const s=o.has(t);if(s?a=o.get(t):(a=r?[]:{},o.set(t,a)),!n.has(t)){const o=i?i+".":"",c=new Set(n).add(t);if(r){let r=0;for(const i of t){const t=e(i,o+r++,c);s||a.push(t)}}else for(const r in t){const i=e(t[r],o+r,c);s||(a[r]=i)}}}}return a}(e,t,new Set),files:s}}(e,"",a),i=JSON.stringify(s);if(o.size){if(!this.FormData)throw Error("GraphQLClient: FormData must be polyfilled or passed in new GraphQLClient({ FormData })");const e=new this.FormData;e.append("operations",i);const t={};let s=0;o.forEach((e=>{t[++s]=e})),e.append("map",JSON.stringify(t)),s=0,o.forEach(((t,r)=>{e.append(""+ ++s,r,r.name)})),r.body=e}else r.headers["Content-Type"]="application/json",r.body=i;return r}request(e,t={}){const r=[],s=e=>r.push(e);return new Promise(((o,i)=>this.middleware.run({operation:e,client:this,addResponseHook:s,resolve:o,reject:i},(({operation:e})=>{const s=e=>{return r.length>0?(t=r,e=>t.reduce(((e,t)=>e.then(t)),Promise.resolve(e)))(e):e;var t};return this.fullWsTransport?this.requestViaWS(e).then(s).then(o).catch(i):this.url?this.requestViaHttp(e,t).then(s).then(o).catch(i):void i(Error("GraphQLClient: config.url is required"))}))))}requestViaHttp(e,t){let r=this.url;const s=this.getFetchOptions(e,t.fetchOptionsOverrides);if("GET"===s.method){if(r=r+"?"+Object.entries(e).filter((([e,r])=>t.hashOnly?"variables"===e:!!r)).map((([e,t])=>("variables"===e&&(t=JSON.stringify(t)),`${e}=${encodeURIComponent(t)}`))).join("&"),e.hash){r+="&extensions="+encodeURIComponent(JSON.stringify({persistedQuery:{version:1,sha256Hash:e.hash}}))}}return this.fetch(r,s).then((e=>e.ok?e.json().then((({errors:r,data:s})=>this.generateResult({graphQLErrors:r,data:"function"==typeof t.responseReducer&&t.responseReducer(s,e)||s}))):e.text().then((t=>{const{status:r,statusText:s}=e;return this.generateResult({httpError:{status:r,statusText:s,body:t}})})))).catch((e=>this.generateResult({fetchError:e}))).then((t=>(t.error&&(this.logErrors&&this.logErrorResult({result:t,operation:e}),this.onError&&this.onError({result:t,operation:e})),t)))}requestViaWS(e){return new Promise(((t,r)=>{let s;try{const o=this.createSubscription(e).subscribe({next:e=>{s=e},error:r,complete:()=>{o.unsubscribe(),t(s)}})}catch(e){r(e)}}))}createSubscription(e){if(!this.subscriptionClient)throw Error("No SubscriptionClient! Please set in the constructor.");return"function"==typeof this.subscriptionClient.subscribe?{subscribe:t=>({unsubscribe:this.subscriptionClient.subscribe(e,t)})}:this.subscriptionClient.request(e)}}class h{constructor(e){this.fetchError=e.fetchError,this.httpError=e.httpError,this.graphQLErrors=e.graphQLErrors}}class l extends u{constructor(e={}){if(super(e),this.localQueries=e.localQueries,this.requestDelayMs=e.requestDelayMs||0,!this.localQueries)throw Error("LocalGraphQLClient: `localQueries` object required in the constructor options")}verifyConfig(){}request(e){if(!this.localQueries[e.query])throw Error("LocalGraphQLClient: no query match for: "+e.query);return(t=this.requestDelayMs,new Promise((e=>{setTimeout(e,t)}))).then((()=>Promise.resolve(this.localQueries[e.query](e.variables,e.operationName)))).then((e=>e instanceof h?{error:e}:{data:e}));var t}}var f=Object.prototype.hasOwnProperty;function p(e,t,r){for(r of e.keys())if(d(r,t))return r}function d(e,t){var r,s,o;if(e===t)return!0;if(e&&t&&(r=e.constructor)===t.constructor){if(r===Date)return e.getTime()===t.getTime();if(r===RegExp)return""+e==""+t;if(r===Array){if((s=e.length)===t.length)for(;s--&&d(e[s],t[s]););return-1===s}if(r===Set){if(e.size!==t.size)return!1;for(s of e){if((o=s)&&"object"==typeof o&&!(o=p(t,o)))return!1;if(!t.has(o))return!1}return!0}if(r===Map){if(e.size!==t.size)return!1;for(s of e){if((o=s[0])&&"object"==typeof o&&!(o=p(t,o)))return!1;if(!d(s[1],t.get(o)))return!1}return!0}if(r===ArrayBuffer)e=new Uint8Array(e),t=new Uint8Array(t);else if(r===DataView){if((s=e.byteLength)===t.byteLength)for(;s--&&e.getInt8(s)===t.getInt8(s););return-1===s}if(ArrayBuffer.isView(e)){if((s=e.byteLength)===t.byteLength)for(;s--&&e[s]===t[s];);return-1===s}if(!r||"object"==typeof e){for(r in s=0,e){if(f.call(e,r)&&++s&&!f.call(t,r))return!1;if(!(r in t)||!d(e[r],t[r]))return!1}return Object.keys(t).length===s}}return e!=e&&t!=t}const E="RESET_STATE",y="LOADING",g="CACHE_HIT",m="REQUEST_RESULT";function b(e,t){switch(t.type){case E:return t.initialState;case y:return e.error?{...t.initialState,data:e.data,loading:!0}:e.loading?e:{...e,loading:!0};case g:return e.cacheHit&&!t.resetState?e:{...t.result,cacheHit:!0,loading:!1};case m:return{...t.result,data:e.data&&t.result.data&&t.updateData?t.updateData(e.data,t.result.data):t.result.data,cacheHit:!1,loading:!1};default:return e}}function C(t,r={}){if("string"!=typeof t)throw Error("Your query must be a string. If you are using the `gql` template literal from graphql-tag, remove it from your query.");const s=e.useContext(i),o=r.client||s,n=e.useRef(!0),a=e.useRef(null),c={query:t,variables:r.variables,operationName:r.operationName,persisted:r.persisted};(r.persisted||o.useGETForQueries&&!r.isMutation)&&(r.fetchOptionsOverrides={...r.fetchOptionsOverrides,method:"GET"});const u=o.getCacheKey(c,r),h=r.isMutation||r.isManual,l=r.skipCache||!o.cache?null:o.cache.get(u),f={...l,cacheHit:!!l,loading:!h&&!l},[p,C]=e.useReducer(b,f),w=JSON.stringify(u);e.useEffect((()=>{r.updateData||C({type:E,initialState:f})}),[w]),e.useEffect((()=>(n.current=!0,()=>{n.current=!1})),[]);const v=function(t,r){const s=e.useRef();return d(r,s.current)||(s.current=r),e.useCallback(t,s.current)}((e=>{const s={...r,...e},i={...c,variables:s.variables,operationName:s.operationName};if(!n.current)return Promise.resolve({error:{fetchError:Error("fetchData should not be called after hook unmounted")},loading:!1,cacheHit:!1});const u=o.getCacheKey(i,s);a.current=u;const h=s.skipCache?null:o.getCache(u);return h?(C({type:g,result:h,resetState:w!==JSON.stringify(p.cacheKey)}),Promise.resolve(h)):(C({type:y,initialState:f}),o.request(i,s).then((e=>{if(s.updateData&&"function"!=typeof s.updateData)throw Error("options.updateData must be a function");const c={...e};if(s.useCache&&(c.useCache=!0,c.cacheKey=u,o.ssrMode)){const e={error:c.error,data:s.updateData?s.updateData(p.data,c.data):c.data};o.saveCache(u,e)}return n.current&&u===a.current&&C({type:m,updateData:s.updateData,result:c}),r.isMutation&&o.mutationsEmitter.emit(t,{...i,mutation:t,result:c}),e})))}),[o,r,c]);e.useEffect((()=>{p.useCache&&!o.ssrMode&&o.saveCache(p.cacheKey,p)}),[o,p]);return[v,p,(e={})=>C({type:E,initialState:{...f,...e}})]}const w={useCache:!0,skip:!1,throwErrors:!1};function v(t,r={}){const s={...w,...r},o=e.useContext(i),n=r.client||o,[a,c]=e.useState(!1),[u,h]=C(t,s);if(n.ssrMode&&!1!==r.ssr&&!a&&!r.skipCache&&!r.skip){if(!h.data&&!h.error){const e=u();n.ssrPromises.push(e)}c(!0)}const l=JSON.stringify(s);e.useEffect((()=>{s.skip||u()}),[t,l]),e.useEffect((()=>{if(h.error&&s.throwErrors)throw h.error}),[h.error,s.throwErrors]);const f=e.useCallback(((e={})=>u({skipCache:!0,updateData:(e,t)=>t,...e})),[u]);return e.useEffect((function(){const e=function(e){const t={};return(Array.isArray(e)?e:[e]).forEach((e=>{if(null==e)return;const r=typeof e;if("string"===r)t[e]={};else if("object"===r){const{filter:r,mutation:s}=e;t[s]={filter:r}}})),t}(r.refetchAfterMutations),t=Object.keys(e),s=({mutation:t,variables:r})=>{const{filter:s}=e[t];(!s||r&&s(r))&&f()};return t.forEach((e=>{n.mutationsEmitter.on(e,s)})),()=>{t.forEach((e=>{n.mutationsEmitter.removeListener(e,s)}))}}),[r.refetchAfterMutations,f,n.mutationsEmitter]),{...h,refetch:f}}function O(e,o){const n=t(o);n.current=o;const a=r(i),c=e.client||a,u={query:e.query,variables:e.variables};s((()=>{const e=c.createSubscription(u).subscribe({next:e=>{n.current(e)},error:e=>{n.current({errors:e})},complete:()=>{e.unsubscribe()}});return()=>{e.unsubscribe()}}),[])}const L=(e,t)=>C(e,{useCache:!0,isManual:!0,...t}),Q=(e,t)=>C(e,{isMutation:!0,...t});export{i as ClientContext,u as GraphQLClient,l as LocalGraphQLClient,h as LocalGraphQLError,C as useClientRequest,L as useManualQuery,Q as useMutation,v as useQuery,O as useSubscription};
